<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manila Rail Commute</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@radix-ui/react-select@1.2.2/dist/select.umd.js"></script>
  <style>
    body {
      background-color: #f9fafb;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    .select-trigger {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      background: white;
      width: 100%;
      font-size: 1rem;
    }
    .select-content {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
    }
    .select-item {
      padding: 0.5rem;
      cursor: pointer;
    }
    .select-item:hover {
      background: #f3f4f6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Manila Rail Commute</h2>
    <div class="mb-4">
      <label for="start" class="block text-sm font-medium text-gray-700">Start Station</label>
      <div id="start-select" class="select-trigger"></div>
    </div>
    <div class="mb-4">
      <label for="dest" class="block text-sm font-medium text-gray-700">Destination Station</label>
      <div id="dest-select" class="select-trigger"></div>
    grades = {
      'Regular': 1.0,
      'Student': 0.8,
      'PWD': 0.8,
      'Senior': 0.8
    };

    // Populate dropdowns with Radix UI
    const allStations = [...new Set(Object.values(stations).flatMap(line => Object.keys(line)))].sort();
    ['start', 'dest', 'user-type'].forEach(id => {
      const select = RadixUI.Select.create({
        onValueChange: (value) => {
          if (id === 'start') startStation = value;
          if (id === 'dest') destStation = value;
          if (id === 'user-type') userType = value;
        }
      });
      const trigger = document.createElement('div');
      trigger.className = 'select-trigger';
      trigger.innerHTML = `<span>${id === 'user-type' ? 'Select User Type' : 'Select Station'}</span><svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"></path></svg>`;
      const content = document.createElement('div');
      content.className = 'select-content';
      const items = id === 'user-type' ? Object.keys(fareDiscounts) : allStations;
      items.forEach(item => {
        const option = document.createElement('div');
        option.className = 'select-item';
        option.innerText = item;
        option.onclick = () => select.setValue(item);
        content.appendChild(option);
      });
      select.append(trigger, content);
      document.getElementById(`${id}-select`).appendChild(select);
    });

    // BFS for shortest path
    function findRoute(start, dest) {
      const queue = [[start]];
      const visited = new Set();
      while (queue.length) {
        const path = queue.shift();
        const node = path[path.length - 1];
        if (node === dest) return path;
        if (!visited.has(node)) {
          visited.add(node);
          for (const next of (graph[node] || [])) {
            queue.push([...path, next]);
          }
        }
      }
      return [];
    }

    // Calculate fare
    function calculateFare(route) {
      let fare = 0;
      let currentLine = null;
      let stationCount = 0;
      let transfers = 0;

      for (let i = 0; i < route.length - 1; i++) {
        const from = route[i];
        const to = route[i + 1];
        const fromLine = Object.keys(stations).find(line => stations[line][from]);
        const toLine = Object.keys(stations).find(line => stations[line][to]);

        if (fromLine !== currentLine && currentLine) transfers++;
        if (fromLine === toLine) stationCount++;
        currentLine = toLine;

        if (i === route.length - 2) {
          if (currentLine === 'LRT1' || currentLine === 'LRT2') {
            fare += 15 + Math.max(0, Math.ceil((stationCount - 4) / 4)) * 5;
          } else if (currentLine === 'MRT3') {
            fare += 13 + Math.max(0, stationCount - 4) * 3;
          }
        }
      }

      fare += transfers * 5; // PHP 5 per transfer
      return Math.round(fare * fareDiscounts[userType]);
    }

    // Haversine distance (km)
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Find closest station
    function findClosestStation(lat, lon) {
      let minDist = Infinity;
      let closest = null;
      for (const line in stations) {
        for (const station in stations[line]) {
          const { lat: sLat, lon: sLon } = stations[line][station];
          const dist = haversineDistance(lat, lon, sLat, sLon);
          if (dist < minDist) {
            minDist = dist;
            closest = station;
          }
        }
      }
      return { station: closest, distance: minDist };
    }

    // Start tracking
    function startTracking() {
      if (!startStation || !destStation || !userType) {
        alert('Please select start station, destination station, and user type');
        return;
      }
      if (!graph[startStation] || !graph[destStation]) {
        alert('Invalid station selected');
        return;
      }

      const route = findRoute(startStation, destStation);
      if (!route.length) {
        alert('No route found between the stations');
        return;
      }
      const fare = calculateFare(route);
      document.getElementById('route').innerHTML = `
        <p><strong>Route:</strong> ${route.join(' â†’ ')}</p>
        <p><strong>Fare:</strong> PHP ${fare} (${userType})</p>
      `;

      if (!navigator.geolocation) {
        alert('Geolocation not supported by your browser');
        return;
      }
      navigator.geolocation.watchPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          const { station, distance } = findClosestStation(latitude, longitude);
          document.getElementById('status').innerHTML = `
            <p><strong>Current Station:</strong> ${station}</p>
            <p><strong>Distance:</strong> ${distance.toFixed(2)} km</p>
          `;
          if (station === destStation && distance < 0.5) {
            alert(`You are near your destination: ${destStation}!`);
            navigator.geolocation.clearWatch(this.watchId);
          }
        },
        (error) => {
          document.getElementById('status').innerHTML = '<p class="text-red-600">Location error: Please enable GPS</p>';
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }
  </script>
</body>
</html>